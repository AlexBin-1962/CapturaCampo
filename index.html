<!DOCTYPE html>
<html lang='es'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>CT-27 · App de Campo (MVP)</title>
<link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css' crossorigin/>
<script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js' crossorigin></script>
<link rel='stylesheet' href='https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css'>
<script src='https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js'></script>
<link href='https://unpkg.com/lucide-static@0.469.0/font/lucide.css' rel='stylesheet'>
<script src='https://unpkg.com/@turf/turf@6.5.0/turf.min.js'></script>
<style>
:root{--bg:#f7f7f8;--panel:#ffffff;--ink:#1f2937;--muted:#6b7280;--brand:#7a1c24;--brand-soft:#f3e7e9;--ok:#16a34a;--warn:#ca8a04;--bad:#dc2626;--shadow:0 10px 25px rgba(0,0,0,.08)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--ink)}
.app{display:grid;grid-template-columns:360px 1fr;height:100%}.panel{background:var(--panel);border-right:1px solid #e5e7eb;display:flex;flex-direction:column}
.panel header{padding:16px 16px 8px;border-bottom:1px solid #f0f0f0}.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--brand-soft);color:var(--brand);font-weight:600;font-size:12px;letter-spacing:.3px}
.panel .section{padding:14px 16px}.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:14px}textarea{min-height:70px;resize:vertical}
.hint{font-size:12px;color:var(--muted)}.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
.btn:hover{transform:translateY(-1px)}.btn[disabled]{opacity:.5;cursor:not-allowed;transform:none}.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.legend{display:flex;flex-wrap:wrap;gap:8px}.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}.dot{width:10px;height:10px;border-radius:999px;display:inline-block}
#map{width:100%;height:100%}.map-wrap{position:relative}.floatbar{position:absolute;right:16px;top:16px;display:flex;flex-direction:column;gap:10px;z-index:500}
.fab{border:none;border-radius:16px;background:#fff;box-shadow:var(--shadow);width:46px;height:46px;display:flex;align-items:center;justify-content:center;cursor:pointer}.fab:hover{transform:translateY(-1px)}
.tooltip{position:absolute;right:56px;background:#111827;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;opacity:0;pointer-events:none;transform:translateY(4px);transition:all .15s}.fab-wrap{position:relative}.fab-wrap:hover .tooltip{opacity:1;transform:translateY(0)}
.toast{position:absolute;left:50%;top:16px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:700;display:none}
table{width:100%;border-collapse:collapse;font-size:13px}th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}th{color:#6b7280;font-weight:700}
@media (max-width:1024px){.app{grid-template-columns:1fr}.panel{position:absolute;z-index:600;inset:0 auto 0 0;width:min(92vw,420px);transform:translateX(-100%);transition:transform .2s ease;box-shadow:var(--shadow)}.panel.open{transform:translateX(0)}.panel-overlay{position:absolute;inset:0;background:rgba(0,0,0,.25);backdrop-filter:saturate(80%) blur(1px);display:none}.panel-overlay.show{display:block}.float-toggle{position:absolute;left:16px;top:16px;z-index:650;border:none;border-radius:16px;background:#fff;box-shadow:var(--shadow);width:46px;height:46px;display:flex;align-items:center;justify-content:center;cursor:pointer}}
</style>
</head>
<body>
<div class='app'>
  <aside class='panel'>
    <header>
      <div class='badge'>CT-27 · App de Campo · MVP</div>
      <div class='hint' style='margin-top:6px'>Modo promotor (captura en sitio). Exporta a GeoJSON/CSV y comparte al admin.</div>
      <div class='hint' style='margin-top:6px;color:#374151'><b>Nota:</b> Versión móvil/tablet listo (panel deslizable). App independiente del portal.</div>
    </header>
    <div class='section' style='border-bottom:1px solid #f0f0f0'>
      <h3 style='margin:0 0 10px 0'>Universo de trabajo</h3>
      <div class='row'>
        <div>
          <label>Ámbito</label>
          <select id='u_ambito'>
            <option value=''>TODOS</option>
            <option value='SECCION'>SECCIÓN</option>
            <option value='MUNICIPIO'>MUNICIPIO</option>
            <option value='DF'>DISTRITO FEDERAL</option>
            <option value='DL'>DISTRITO LOCAL</option>
          </select>
        </div>
        <div>
          <label>Clave / Nombre</label>
          <input id='u_clave' placeholder='Ej. 1234 o León'/>
        </div>
      </div>
      <div class='toolbar'>
        <button class='btn' id='btnAplicarUniverso'><i class='lucide-filter'></i><span>Aplicar filtro</span></button>
        <button class='btn' id='btnLimpiarUniverso'><i class='lucide-eraser'></i><span>Limpiar</span></button>
        <span id='universoBadge' class='badge' style='display:none'></span>
      </div>
      <div class='hint'>Este filtro limita lo que ves y exportas en este equipo. No borra datos.</div>
    </div>
    <div class='section'>
      <h3 style='margin:0 0 10px 0'>Nueva captura</h3>
      <div style='display:grid;gap:10px'>
        <div><label>Nombre completo</label><input id='f_nombre' placeholder='Nombre y apellidos'/></div>
        <div class='row'>
          <div><label>Teléfono</label><input id='f_tel' placeholder='10 dígitos'/></div>
          <div><label>Identificador</label><input id='f_id' placeholder='Clave interna opcional'/></div>
        </div>
        <div><label>Domicilio</label><input id='f_dom' placeholder='Calle y número'/></div>
        <div class='row'>
          <div><label>Colonia</label><input id='f_colonia' placeholder='Colonia / Barrio'/></div>
          <div><label>Ciudad</label><input id='f_ciudad' placeholder='Ciudad / Municipio'/></div>
        </div>
        <div class='row'>
          <div><label>Código Postal</label><input id='f_cp' placeholder='CP'/></div>
          <div><label>&nbsp;</label><button class='btn' id='btnGeocode' style='width:100%'><i class='lucide-map'></i><span>Geocodificar domicilio</span></button></div>
        </div>
        <div class='row'>
          <div><label>Categoría</label><select id='f_cat'></select></div>
          <div><label>Color</label><input id='f_color' type='color'/></div>
        </div>
        <div class='row'>
          <div>
            <label>Ámbito</label>
            <select id='f_ambito'>
              <option value='SECCION'>SECCIÓN</option>
              <option value='MUNICIPIO'>MUNICIPIO</option>
              <option value='DF'>DISTRITO FEDERAL</option>
              <option value='DL'>DISTRITO LOCAL</option>
            </select>
          </div>
          <div><label>Clave de ámbito</label><input id='f_ambito_clave' placeholder='Se autollenará por punto'/></div>
        </div>
        <div class='row'>
          <div><label>MUNICIPIO (auto)</label><input id='auto_mun' disabled placeholder='—'/></div>
          <div><label>DIST. FEDERAL (auto)</label><input id='auto_df' disabled placeholder='—'/></div>
        </div>
        <div class='row'>
          <div><label>DIST. LOCAL (auto)</label><input id='auto_dl' disabled placeholder='—'/></div>
          <div><label>SECCIÓN (auto)</label><input id='auto_sec' disabled placeholder='—'/></div>
        </div>
        <div><label>Notas</label><textarea id='f_notas' placeholder='Observaciones, acuerdos, seguimiento...'></textarea></div>
      </div>
      <div class='toolbar'>
        <button class='btn' id='btnPointer'><i class='lucide-map-pin'></i><span>Poner punto en mapa</span></button>
        <button class='btn' id='btnGPS'><i class='lucide-crosshair'></i><span>Usar GPS</span></button>
        <button class='btn btn-primary' id='btnGuardar'><i class='lucide-save'></i><span>Guardar</span></button>
      </div>
      <div class='hint' style='margin-top:6px'>Tip: puedes geocodificar por domicilio y se llenarán automáticamente MUNICIPIO, DF, DL y SECCIÓN.</div>
    </div>
    <div class='section' style='border-top:1px solid #f0f0f0'>
      <h3 style='margin:0 0 10px 0'>Registros (local)</h3>
      <div class='toolbar'>
        <button class='btn' id='btnExportGeo'><i class='lucide-download'></i><span>Exportar GeoJSON</span></button>
        <button class='btn' id='btnExportCSV'><i class='lucide-table'></i><span>Exportar CSV</span></button>
        <label class='btn' for='fileImport'><i class='lucide-upload'></i><span>Importar GeoJSON</span></label>
        <input id='fileImport' type='file' accept='.json,.geojson' style='display:none'/>
        <button class='btn' id='btnLimpiar'><i class='lucide-trash-2'></i><span>Vaciar todo</span></button>
      </div>
      <div style='max-height:160px;overflow:auto;margin-top:10px'>
        <table id='tbl'><thead><tr><th>#</th><th>Nombre</th><th>Categoría</th><th>Ámbito/Sección</th><th>Lat</th><th>Lng</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class='section' style='border-top:1px solid #f0f0f0'>
      <h3 style='margin:0 8px 10px 0;display:flex;align-items:center;gap:8px'>Leyenda</h3>
      <div class='legend' id='legend'></div>
    </div>
    <div class='section' style='border-top:1px solid #f0f0f0'>
      <h3 style='margin:0 0 10px 0;display:flex;align-items:center;gap:8px'><i class='lucide-git-commit'></i> Sincronización & Datos</h3>
      <div style='display:grid;gap:10px'>
        <div><label>URL secciones.geojson</label><input id='cfg_url_secciones' placeholder='/data/secciones.geojson'/></div>
        <div><label>URL catálogo municipios (JSON)</label><input id='cfg_url_mun_catalog' placeholder='/data/mun_catalog.json'/></div>
        <div class='row'>
          <div><label>GitHub Owner</label><input id='cfg_gh_owner' placeholder='org o usuario'/></div>
          <div><label>Repo</label><input id='cfg_gh_repo' placeholder='nombre del repositorio'/></div>
        </div>
        <div class='row'>
          <div><label>Branch</label><input id='cfg_gh_branch' placeholder='main'/></div>
          <div><label>Ruta y archivo</label><input id='cfg_gh_path' placeholder='data/ct27_registros.geojson'/></div>
        </div>
        <div class='row'>
          <div><label>Ruta PRUEBAS</label><input id='cfg_gh_path_pruebas' placeholder='data/ct27_registros_pruebas.geojson'/></div>
          <div><label>Modo Pruebas</label><div style='display:flex;align-items:center;gap:8px'><input id='cfg_mode_pruebas' type='checkbox'/><span class='hint'>Si está activo, se sincroniza a la ruta de PRUEBAS y marca cada captura como prueba.</span></div></div>
        </div>
        <div><label>Token GitHub (no se guarda en servidor)</label><input id='cfg_gh_token' type='password' placeholder='token con permiso de contents'/></div>
        <div class='row'>
          <div><label>Bloquear configuración</label><div style='display:flex;align-items:center;gap:8px'><input id='cfg_lock' type='checkbox'/><span class='hint'>Oculta/inhabilita campos de configuración para promotores</span></div></div>
          <div><label>Cargar config remota</label><div class='toolbar' style='margin:0;padding:0'><button class='btn' id='btnLoadConfigUrl'><i class='lucide-link'></i><span>Desde URL</span></button><label class='btn' for='fileConfig'><i class='lucide-file-input'></i><span>Desde archivo</span></label><input id='fileConfig' type='file' accept='.json' style='display:none'/></div></div>
        </div>
      </div>
      <div class='toolbar'>
        <button class='btn' id='btnShareCfg'><i class='lucide-share-2'></i><span>Copiar enlace para promotor</span></button>
        <button class='btn' id='btnSaveConfig'><i class='lucide-save'></i><span>Guardar configuración</span></button>
        <button class='btn' id='btnTestSecciones'><i class='lucide-check-circle-2'></i><span>Probar secciones</span></button>
        <button class='btn' id='btnLoadGitHub'><i class='lucide-cloud-download'></i><span>Cargar desde GitHub</span></button>
        <button class='btn btn-primary' id='btnSyncGitHub'><i class='lucide-cloud-upload'></i><span>Sincronizar a GitHub</span></button>
        <button class='btn' id='btnRunTests'><i class='lucide-bug'></i><span>Auto-tests</span></button>
      </div>
      <pre id='testlog' style='font-size:11px;color:#6b7280;background:#f9fafb;padding:8px;border-radius:8px;max-height:120px;overflow:auto;display:none'></pre>
    </div>
  </aside>
  <main class='map-wrap'>
    <button class='float-toggle' id='btnTogglePanel' title='Panel'><i class='lucide-menu'></i></button>
    <div id='map'></div>
    <div class='toast' id='toast'></div>
    <div class='floatbar'>
      <div class='fab-wrap'><button class='fab' id='btnSearch'><i class='lucide-search'></i></button><div class='tooltip'>Buscar dirección (Nominatim)</div></div>
      <div class='fab-wrap'><button class='fab' id='btnLocate'><i class='lucide-crosshair'></i></button><div class='tooltip'>Centrar en mi ubicación</div></div>
      <div class='fab-wrap'><button class='fab' id='btnFit'><i class='lucide-maximize-2'></i></button><div class='tooltip'>Ajustar a marcadores</div></div>
    </div>
  </main>
</div>
<script>
const CATEGORIAS=[{id:'SIMPATIZANTE',color:'#60a5fa'},{id:'LIDER',color:'#22c55e'},{id:'ADVERSARIO',color:'#ef4444'},{id:'REP_CASILLA',label:'REP. CASILLA',color:'#a855f7'},{id:'REP_GENERAL',label:'REP. GENERAL',color:'#f59e0b'},{id:'OBSERVADOR',color:'#94a3b8'}];
const DEFAULT_URL_SECCIONES='/estrategico/data/geo/secciones.geojson';const CONFIG_KEY='ct27_campo_config_v1';const FILTER_KEY='ct27_campo_filtro_v1';const STORAGE_KEY='ct27_campo_registros_v1';
let CONFIG={url_secciones:DEFAULT_URL_SECCIONES,url_mun_catalog:'',gh_owner:'',gh_repo:'',gh_branch:'main',gh_path:'data/ct27_registros.geojson',gh_path_pruebas:'data/ct27_registros_pruebas.geojson',mode_pruebas:false,lock_config:false};
let FILTRO={ambito:'',clave:''};let SECCIONES_FC=null;let MUN_CATALOG={};let modoColocar=false;let punteroTemporal=null;
const $=s=>document.querySelector(s);function toast(m,ms=1800){const t=$('#toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',ms)}
const norm=s=>(s??'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase();function matchName(h,n){const H=norm(h),N=norm(n);if(!N)return true;if(H===N)return true;return H.includes(N)}
function resolveMunCodeFromName(name){const N=norm(name);for(const [code,nm] of Object.entries(MUN_CATALOG)){if(norm(nm)===N||norm(nm).includes(N))return code}return null}
function munMatchesRecord(rec,clave){if(!clave)return true;const isNum=/^\d{1,3}$/.test(clave.trim());if(isNum){const cIn=String(parseInt(clave,10));const cRec=String(parseInt(rec.mun,10));return cRec===cIn||cRec.padStart(2,'0')===cIn.padStart(2,'0')}else{if(rec.mun_nombre&&matchName(rec.mun_nombre,clave))return true;const code=resolveMunCodeFromName(clave);if(code!=null){const cRec=String(parseInt(rec.mun,10));return cRec===String(parseInt(code,10))}return false}}
function munMatchesFeature(feat,clave){const p=feat.properties||{};const codeVal=p.MUNICIPIO??p.MUN??p.CVE_MUN??p.MUN_ID;const nameVal=p.MUNICIPIO_NOM??p.NOM_MUN??p.NOMBRE_MUN??p.MUN_NOM;if(!clave)return true;const isNum=/^\d{1,3}$/.test(clave.trim());if(isNum){return String(parseInt(codeVal,10))===String(parseInt(clave,10))}else{if(nameVal)return matchName(nameVal,clave);const code=resolveMunCodeFromName(clave);if(code!=null){return String(parseInt(codeVal,10))===String(parseInt(code,10))}return false}}
function toCSV(rows){const esc=v=>'"'+String(v??'').replaceAll('"','""')+'"';const header=Object.keys(rows[0]||{});const lines=[header.map(esc).join(',')];for(const r of rows){lines.push(header.map(k=>esc(r[k])).join(','))}return lines.join('\n')}
function cargar(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}}
function guardar(regs){localStorage.setItem(STORAGE_KEY,JSON.stringify(regs));renderTabla();renderLegend();dibujarCapa()}
function cargarFiltro(){try{FILTRO=Object.assign(FILTRO,JSON.parse(localStorage.getItem(FILTER_KEY)||'{}'))}catch{}}
function guardarFiltro(next){FILTRO=Object.assign(FILTRO,next);localStorage.setItem(FILTER_KEY,JSON.stringify(FILTRO));actualizarBadgeUniverso();renderTabla();dibujarCapa()}
function getFilteredRegs(){const all=cargar();const {ambito,clave}=FILTRO;if(!ambito&&!clave)return all;return all.filter(r=>{if(ambito&&ambito!==''&&ambito!=='SECCION'&&r.ambito!==ambito)return false;if(ambito==='SECCION'){return matchName(r.seccion||r.ambito_clave||'',clave)}if(ambito==='MUNICIPIO'){return matchName(r.mun_nombre || r.mun || '', clave);}if(ambito==='DF'){return matchName(r.df||'',clave)}if(ambito==='DL'){return matchName(r.dl||'',clave)}if(!ambito&&clave){const c=norm(clave);return [r.seccion,r.ambito_clave,r.mun,r.df,r.dl].some(v=>norm(v)===c||norm(v).includes(c))}return true})}
(function initForm(){const sel=$('#f_cat');CATEGORIAS.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.label||c.id;sel.appendChild(o)});sel.addEventListener('change',e=>{$('#f_color').value=(CATEGORIAS.find(x=>x.id===e.target.value)||{}).color||'#7a1c24'});sel.value='SIMPATIZANTE';$('#f_color').value=CATEGORIAS[0].color})();
$('#u_ambito')?.addEventListener('change',e=>{const amb=e.target.value,input=$('#u_clave');if(!input)return;if(amb==='MUNICIPIO')input.placeholder='Nombre o código del municipio (ej. León o 21)';else if(amb==='SECCION')input.placeholder='No. de sección (ej. 1234)';else if(amb==='DF')input.placeholder='Distrito Federal (ej. 05)';else if(amb==='DL')input.placeholder='Distrito Local (ej. 13)';else input.placeholder='Ej. SECCIÓN 1234 o municipio'});
const map=L.map('map',{zoomControl:true}).setView([21.122,-101.682],12);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
const capaRegistros=L.layerGroup().addTo(map);let capaSecciones=L.geoJSON(null,{style:feat=>({color:'#7a1c24',weight:1,fillColor:'#7a1c24',fillOpacity:.08}),onEachFeature:(feat,layer)=>{const p=feat.properties||{};const sec=p.SECCION??p.SEC??'—';const mun=p.MUNICIPIO_NOM??p.MUNICIPIO??p.MUN??'—';const df=p.DISTRITO_F??p.DF??'—';const dl=p.DISTRITO_L??p.DL??'—';layer.bindTooltip(`Sec: ${sec} · Mun: ${mun} · DF: ${df} · DL: ${dl}`);layer.on('mouseover',()=>layer.setStyle({weight:2,fillOpacity:.15}));layer.on('mouseout',()=>layer.setStyle({weight:1,fillOpacity:.08}))}}).addTo(map);
async function tryLoadRemoteConfig(){const p=new URLSearchParams(location.search);const cfg=p.get('cfg');if(!cfg)return;try{const r=await fetch(cfg,{cache:'no-store'});if(!r.ok)return;const remote=await r.json();CONFIG=Object.assign(CONFIG,remote||{});localStorage.setItem(CONFIG_KEY,JSON.stringify(CONFIG));toast('Configuración remota aplicada')}catch{}}
function cargarConfig(){try{CONFIG=Object.assign(CONFIG,JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}'))}catch{};$('#cfg_url_secciones')?.setAttribute('value',CONFIG.url_secciones||'');$('#cfg_url_mun_catalog')?.setAttribute('value',CONFIG.url_mun_catalog||'');$('#cfg_gh_owner')?.setAttribute('value',CONFIG.gh_owner||'');$('#cfg_gh_repo')?.setAttribute('value',CONFIG.gh_repo||'');$('#cfg_gh_branch')?.setAttribute('value',CONFIG.gh_branch||'');$('#cfg_gh_path')?.setAttribute('value',CONFIG.gh_path||'');$('#cfg_gh_path_pruebas')?.setAttribute('value',CONFIG.gh_path_pruebas||'');$('#cfg_mode_pruebas')&&($('#cfg_mode_pruebas').checked=!!CONFIG.mode_pruebas);$('#cfg_lock')&&($('#cfg_lock').checked=!!CONFIG.lock_config);const lock=!!CONFIG.lock_config;['#cfg_url_secciones','#cfg_url_mun_catalog','#cfg_gh_owner','#cfg_gh_repo','#cfg_gh_branch','#cfg_gh_path','#cfg_gh_path_pruebas','#cfg_gh_token','#btnSaveConfig','#btnLoadConfigUrl','#fileConfig','#btnLoadGitHub','#btnSyncGitHub','#btnRunTests','#btnTestSecciones'].forEach(sel=>{const el=$(sel);if(el){const host=el.closest('.row')||el;host.style.display=lock?'none':''}});const share=$('#btnShareCfg');if(share){share.style.display='inline-flex'}}
function guardarConfig(){const fix=s=>(s||'').replace(/\\/g,'/');const next={url_secciones:fix($('#cfg_url_secciones')?.value?.trim())||CONFIG.url_secciones,url_mun_catalog:fix($('#cfg_url_mun_catalog')?.value?.trim())||CONFIG.url_mun_catalog||'',gh_owner:$('#cfg_gh_owner')?.value?.trim()||'',gh_repo:$('#cfg_gh_repo')?.value?.trim()||'',gh_branch:$('#cfg_gh_branch')?.value?.trim()||'main',gh_path:fix($('#cfg_gh_path')?.value?.trim()||'data/ct27_registros.geojson'),gh_path_pruebas:fix($('#cfg_gh_path_pruebas')?.value?.trim()||'data/ct27_registros_pruebas.geojson'),mode_pruebas:!!$('#cfg_mode_pruebas')?.checked,lock_config:!!$('#cfg_lock')?.checked};CONFIG=Object.assign(CONFIG,next);localStorage.setItem(CONFIG_KEY,JSON.stringify(CONFIG));cargarConfig()}
function actualizarBadgeUniverso(){const badge=$('#universoBadge');const a=FILTRO.ambito||'TODOS';const k=FILTRO.clave||'';if(!FILTRO.ambito&&!FILTRO.clave){badge.style.display='none';return}badge.textContent=`Universo: ${a}${k?(' · '+k):''}`;badge.style.display='inline-block'}
(async function boot(){await tryLoadRemoteConfig();cargarConfig();cargarFiltro();actualizarBadgeUniverso();try{const r=await fetch(CONFIG.url_secciones||DEFAULT_URL_SECCIONES);if(r.ok){SECCIONES_FC=await r.json()}}catch(e){console.warn('No se pudo cargar secciones.geojson',e)}try{if(CONFIG.url_mun_catalog){const r=await fetch(CONFIG.url_mun_catalog,{cache:'no-store'});if(r.ok){MUN_CATALOG=await r.json()}}}catch(e){}dibujarSecciones();renderTabla();renderLegend();dibujarCapa()})();
map.on('click',e=>{if(!modoColocar)return;colocarPuntero(e.latlng)});
function colocarPuntero(latlng){if(punteroTemporal)map.removeLayer(punteroTemporal);punteroTemporal=L.circleMarker(latlng,{radius:8,weight:2,color:'#111827',fillColor:$('#f_color').value,fillOpacity:.9}).addTo(map);punteroTemporal.bindTooltip('Punto provisional',{permanent:false});modoColocar=false;$('#btnPointer').disabled=false;toast('Punto colocado. Ahora “Guardar”.');autocompletarAmbitoDesdeSecciones(latlng)}
$('#btnLocate')?.addEventListener('click',()=>{map.locate({setView:true,maxZoom:17})});map.on('locationerror',()=>toast('No se pudo obtener tu ubicación. Revisa permisos.'));
$('#btnFit')?.addEventListener('click',()=>{if(capaRegistros.getLayers().length===0){toast('No hay marcadores aún.');return}map.fitBounds(capaRegistros.getBounds(),{padding:[30,30]})});
$('#btnSearch')?.addEventListener('click',async()=>{const q=prompt('Buscar dirección (ciudad, calle, número)...');if(!q)return;try{const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;const r=await fetch(url,{headers:{'Accept-Language':'es'}});const data=await r.json();if(!data.length)return toast('Sin resultados. Refina la búsqueda.');const {lat,lon,display_name}=data[0];map.setView([parseFloat(lat),parseFloat(lon)],17);toast(display_name)}catch(err){toast('Error al buscar. ¿Sin internet?')}});
function dibujarCapa(){capaRegistros.clearLayers();const regs=getFilteredRegs();regs.forEach(r=>{if(!r.lat||!r.lng)return;const mk=L.circleMarker([Number(r.lat),Number(r.lng)],{radius:7,weight:2,color:'#111827',fillColor:r.color||'#7a1c24',fillOpacity:.9});const pruebaTag=r.prueba?' <span style="color:#ef4444">[PRUEBA]</span>':'';mk.bindTooltip(`${r.categoria||'CAT'} · ${r.nombre||'Sin nombre'}${pruebaTag}`,{permanent:false});mk.bindPopup(`<b>${r.nombre||''}</b>${pruebaTag}<br>${r.categoria} · ${r.ambito} ${r.ambito_clave||''}<br>${r.domicilio||''}<br><small>${r.notas||''}</small>`);capaRegistros.addLayer(mk)})}
function coincideUniverso(feat){if(!FILTRO.ambito&&!FILTRO.clave)return true;const p=feat.properties||{};const clave=FILTRO.clave||'';if(FILTRO.ambito==='SECCION'){return matchName(p.SECCION??p.SEC??'',clave)}if(FILTRO.ambito==='MUNICIPIO'){return matchName(p.NOMBREMUN ?? p.MUNICIPIO_NOM ?? p.NOM_MUN ?? p.MUN_NOM ?? '', clave)}if(FILTRO.ambito==='DF'){return matchName(p.DISTRITO_F??p.DF??'',clave)}if(FILTRO.ambito==='DL'){return matchName(p.DISTRITO_L??p.DL??'',clave)}if(!FILTRO.ambito&&clave){const vals=[p.SECCION??p.SEC,p.MUNICIPIO??p.MUN,p.DISTRITO_F??p.DF,p.DISTRITO_L??p.DL];return vals.some(v=>matchName(v,clave)||munMatchesFeature({properties:{MUNICIPIO:v}},clave))}return true}
function dibujarSecciones(){capaSecciones.clearLayers();if(!SECCIONES_FC?.features?.length)return;const feats=SECCIONES_FC.features.filter(coincideUniverso);capaSecciones.addData({type:'FeatureCollection',features:feats});if((FILTRO.ambito||FILTRO.clave)&&capaSecciones.getLayers().length){try{map.fitBounds(capaSecciones.getBounds(),{padding:[30,30]})}catch{}}}
$('#btnGeocode')?.addEventListener('click',async()=>{const part=[$('#f_dom').value,$('#f_colonia').value,$('#f_ciudad').value,$('#f_cp').value].filter(Boolean).join(', ');if(!part)return toast('Escribe al menos calle/número y ciudad');try{const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(part)}`;const r=await fetch(url,{headers:{'Accept-Language':'es'}});const data=await r.json();if(!data.length)return toast('Sin resultados para ese domicilio');const best=data[0];const latlng=L.latLng(parseFloat(best.lat),parseFloat(best.lon));map.setView(latlng,18);colocarPuntero(latlng)}catch(err){toast('Error al geocodificar')}});
function autocompletarAmbitoDesdeSecciones(latlng){if(!SECCIONES_FC?.features?.length)return;const pt=turf.point([latlng.lng,latlng.lat]);for(const f of SECCIONES_FC.features){try{if(turf.booleanPointInPolygon(pt,f)){const p=f.properties||{};const mun = p.NOMBREMUN ?? p.MUNICIPIO_NOM ?? p.NOM_MUN ?? p.MUN_NOM ?? p.MUNICIPIO ?? p.MUN ?? '—';
$('#auto_df').value=p.DISTRITO_F??p.DF??'';$('#auto_dl').value=p.DISTRITO_L??p.DL??'';$('#auto_sec').value=p.SECCION??p.SEC??'';$('#f_ambito').value='SECCION';$('#f_ambito_clave').value=$('#auto_sec').value||'';break}}catch{}}}
$('#btnPointer')?.addEventListener('click',()=>{modoColocar=true;$('#btnPointer').disabled=true;toast('Click en el mapa para colocar el punto')});
$('#btnGPS')?.addEventListener('click',()=>{map.locate({setView:true,maxZoom:18,watch:false,enableHighAccuracy:true});map.once('locationfound',e=>{colocarPuntero(e.latlng)})});
$('#btnGuardar')?.addEventListener('click',()=>{const nombre=$('#f_nombre').value.trim();const categoria=$('#f_cat').value;if(!nombre){toast('Falta nombre');return}if(!punteroTemporal){toast('Coloca el punto (mapa/GPS/geocodificación)');return}const regs=cargar();const nuevo={id:$('#f_id').value.trim()||`R${Date.now()}`,nombre,tel:$('#f_tel').value.trim(),domicilio:[$('#f_dom').value.trim(),$('#f_colonia').value.trim(),$('#f_ciudad').value.trim(),$('#f_cp').value.trim()].filter(Boolean).join(', '),categoria,color:$('#f_color').value,ambito:$('#f_ambito').value,ambito_clave:$('#f_ambito_clave').value.trim(),mun:$('#auto_mun').value||'',df:$('#auto_df').value||'',dl:$('#auto_dl').value||'',seccion:$('#auto_sec').value||'',notas:$('#f_notas').value.trim(),lat:punteroTemporal.getLatLng().lat,lng:punteroTemporal.getLatLng().lng,prueba:!!CONFIG.mode_pruebas,created_at:new Date().toISOString()};regs.push(nuevo);guardar(regs);if(punteroTemporal){map.removeLayer(punteroTemporal);punteroTemporal=null}['#f_nombre','#f_tel','#f_id','#f_dom','#f_colonia','#f_ciudad','#f_cp','#f_notas','#f_ambito_clave','#auto_mun','#auto_df','#auto_dl','#auto_sec'].forEach(s=>$(s).value='');toast('Registro guardado')});
$('#btnLimpiar')?.addEventListener('click',()=>{if(confirm('¿Eliminar TODOS los registros locales?')){localStorage.removeItem(STORAGE_KEY);guardar([]);toast('Registros eliminados')}});
$('#btnExportGeo')?.addEventListener('click',()=>{const regs=getFilteredRegs();const fc={type:'FeatureCollection',features:regs.filter(r=>r.lat&&r.lng).map(r=>({type:'Feature',properties:{id:r.id,nombre:r.nombre,tel:r.tel,domicilio:r.domicilio,categoria:r.categoria,color:r.color,ambito:r.ambito,ambito_clave:r.ambito_clave,notas:r.notas,created_at:r.created_at,prueba:!!r.prueba},geometry:{type:'Point',coordinates:[r.lng,r.lat]}}))};const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/json;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`ct27_campo_${new Date().toISOString().slice(0,10)}.geojson`;a.click();URL.revokeObjectURL(url)});
$('#btnExportCSV')?.addEventListener('click',()=>{const regs=getFilteredRegs();if(!regs.length)return toast('Sin datos');const rows=regs.map(r=>({id:r.id,nombre:r.nombre,tel:r.tel,domicilio:r.domicilio,categoria:r.categoria,color:r.color,ambito:r.ambito,ambito_clave:r.ambito_clave,notas:r.notas,lat:r.lat,lng:r.lng,created_at:r.created_at,prueba:r.prueba}));const csv=toCSV(rows);const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`ct27_campo_${new Date().toISOString().slice(0,10)}.csv`;a.click();URL.revokeObjectURL(url)});
$('#fileImport')?.addEventListener('change',async e=>{const file=e.target.files[0];if(!file)return;try{const text=await file.text();const json=JSON.parse(text);if(json.type!=='FeatureCollection')throw new Error('No es FeatureCollection');const base=cargar();const nuevos=(json.features||[]).map((f,i)=>({id:f.properties?.id||`IMP${Date.now()}_${i}`,nombre:f.properties?.nombre||'',tel:f.properties?.tel||'',domicilio:f.properties?.domicilio||'',categoria:f.properties?.categoria||'SIMPATIZANTE',color:f.properties?.color||'#7a1c24',ambito:f.properties?.ambito||'SECCION',ambito_clave:f.properties?.ambito_clave||'',mun:f.properties?.mun||'',df:f.properties?.df||'',dl:f.properties?.dl||'',seccion:f.properties?.seccion||'',lat:f.geometry?.coordinates?.[1]||null,lng:f.geometry?.coordinates?.[0]||null,notas:f.properties?.notas||'',prueba:!!f.properties?.prueba,created_at:f.properties?.created_at||new Date().toISOString()}));guardar(base.concat(nuevos));toast(`Importados ${nuevos.length} registros`);e.target.value=''}catch(err){toast('Archivo inválido')}});
function renderTabla(){const tbody=document.querySelector('#tbl tbody');if(!tbody)return;tbody.innerHTML='';const regs=getFilteredRegs();regs.forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${r.nombre||''}</td><td>${r.categoria||''}${r.prueba?' [PRUEBA]':''}</td><td>${r.seccion||r.ambito||''}</td><td>${(r.lat||'').toFixed?r.lat.toFixed(5):''}</td><td>${(r.lng||'').toFixed?r.lng.toFixed(5):''}</td>`;tbody.appendChild(tr)})}
function renderLegend(){const l=$('#legend');if(!l)return;l.innerHTML='';CATEGORIAS.forEach(c=>{const chip=document.createElement('div');chip.className='chip';chip.innerHTML=`<span class="dot" style="background:${c.color}"></span>${c.label||c.id}`;l.appendChild(chip)})}
function aplicarUniverso(){const amb=$('#u_ambito').value;const cla=$('#u_clave').value.trim();guardarFiltro({ambito:amb,clave:cla});dibujarSecciones();dibujarCapa();setTimeout(()=>{if(capaRegistros.getLayers().length){map.fitBounds(capaRegistros.getBounds(),{padding:[30,30]})}},10)}
function limpiarUniverso(){$('#u_ambito').value='';$('#u_clave').value='';guardarFiltro({ambito:'',clave:''});dibujarSecciones();dibujarCapa();setTimeout(()=>{if(capaRegistros.getLayers().length){map.fitBounds(capaRegistros.getBounds(),{padding:[30,30]})}},10)}
$('#btnAplicarUniverso')?.addEventListener('click',aplicarUniverso);$('#btnLimpiarUniverso')?.addEventListener('click',limpiarUniverso);
$('#btnSaveConfig')?.addEventListener('click',()=>{guardarConfig();toast('Configuración guardada')});
$('#btnTestSecciones')?.addEventListener('click',async()=>{try{guardarConfig();const r=await fetch(CONFIG.url_secciones||DEFAULT_URL_SECCIONES);if(!r.ok)throw new Error('HTTP '+r.status);SECCIONES_FC=await r.json();if(CONFIG.url_mun_catalog){const rc=await fetch(CONFIG.url_mun_catalog,{cache:'no-store'});if(rc.ok){MUN_CATALOG=await rc.json()}}toast('Secciones y catálogo cargados OK');dibujarSecciones()}catch(e){toast('Error al cargar secciones/catálogo')}});
$('#btnLoadConfigUrl')?.addEventListener('click',async()=>{const url=prompt('URL de configuración (JSON)');if(!url)return;try{const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);const remote=await r.json();CONFIG=Object.assign(CONFIG,remote||{});localStorage.setItem(CONFIG_KEY,JSON.stringify(CONFIG));cargarConfig();toast('Configuración remota aplicada')}catch(e){toast('No se pudo cargar la configuración')}});
$('#fileConfig')?.addEventListener('change',async e=>{const file=e.target.files[0];if(!file)return;try{const text=await file.text();const cfg=JSON.parse(text);CONFIG=Object.assign(CONFIG,cfg||{});localStorage.setItem(CONFIG_KEY,JSON.stringify(CONFIG));cargarConfig();toast('Configuración aplicada desde archivo')}catch{toast('Archivo de configuración inválido')}e.target.value=''});
function buildConfigLink(){const owner=CONFIG.gh_owner||location.hostname.split('.')[0]||'';const repo=CONFIG.gh_repo||'CapturaCampo';const cfgPublicUrl=`https://${owner}.github.io/${repo}/config.json`;const base=location.origin+location.pathname;return `${base}?cfg=${encodeURIComponent(cfgPublicUrl)}`}
$('#btnShareCfg')?.addEventListener('click',async()=>{try{const link=buildConfigLink();await navigator.clipboard.writeText(link);toast('Enlace copiado')}catch{prompt('Copia este enlace:',buildConfigLink())}});
async function ghGetFile(owner,repo,path,branch){const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`);if(r.status===404)return null;if(!r.ok)throw new Error('GET contents failed');return await r.json()}
function toBase64Utf8(str){const utf8=new TextEncoder().encode(str);let binary='';utf8.forEach(b=>binary+=String.fromCharCode(b));return btoa(binary)}
async function ghPutFile({owner,repo,path,branch,token,content,message}){const existing=await ghGetFile(owner,repo,path,branch).catch(()=>null);const body={message,content:toBase64Utf8(content),branch};if(existing?.sha)body.sha=existing.sha;const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`,{method:'PUT',headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json'},body:JSON.stringify(body)});if(!r.ok)throw new Error('PUT contents failed');return await r.json()}
function decodeGithubJsonContent(meta){if(!meta||!meta.content)throw new Error('Contenido vacío en GitHub');const b64=meta.content.replace(/\n/g,'');const bin=atob(b64);const bytes=Uint8Array.from(bin,ch=>ch.charCodeAt(0));const text=new TextDecoder().decode(bytes);return JSON.parse(text)}
$('#btnSyncGitHub')?.addEventListener('click',async()=>{try{guardarConfig();const owner=CONFIG.gh_owner,repo=CONFIG.gh_repo,branch=CONFIG.gh_branch;const token=$('#cfg_gh_token')?.value?.trim();let path=CONFIG.gh_path;if(CONFIG.mode_pruebas){path=CONFIG.gh_path_pruebas||'data/ct27_registros_pruebas.geojson'}if(!owner||!repo||!branch||!path||!token)return toast('Faltan datos de GitHub');const regs=getFilteredRegs();const fc={type:'FeatureCollection',features:regs.filter(r=>r.lat&&r.lng).map(r=>({type:'Feature',properties:{id:r.id,nombre:r.nombre,tel:r.tel,domicilio:r.domicilio,categoria:r.categoria,color:r.color,ambito:r.ambito,ambito_clave:r.ambito_clave,notas:r.notas,created_at:r.created_at,prueba:!!r.prueba},geometry:{type:'Point',coordinates:[r.lng,r.lat]}}))};const payload=JSON.stringify(fc,null,2);await ghPutFile({owner,repo,path,branch,token,content:payload,message:`CT-27: sync ${new Date().toISOString()}${CONFIG.mode_pruebas?' [PRUEBAS]':''}`});toast(`Sincronizado en GitHub ✅ ${CONFIG.mode_pruebas?'(PRUEBAS)':''}`)}catch(e){console.error(e);toast('Error al sincronizar')}});
$('#btnLoadGitHub')?.addEventListener('click',async()=>{try{guardarConfig();const owner=CONFIG.gh_owner;const repo=CONFIG.gh_repo;const branch=CONFIG.gh_branch;let path=CONFIG.gh_path;if(CONFIG.mode_pruebas){path=CONFIG.gh_path_pruebas||'data/ct27_registros_pruebas.geojson'}if(!owner||!repo||!branch||!path){toast('Configura Owner/Repo/Branch/Path');return}const meta=await ghGetFile(owner,repo,path,branch);if(!meta||!meta.content){toast('Archivo no encontrado en GitHub');return}const json=decodeGithubJsonContent(meta);if(json.type!=='FeatureCollection'){toast('El archivo no es FeatureCollection');return}const base=cargar();const nuevos=(json.features||[]).map((f,i)=>({id:f.properties?.id||`GH${Date.now()}_${i}`,nombre:f.properties?.nombre||'',tel:f.properties?.tel||'',domicilio:f.properties?.domicilio||'',categoria:f.properties?.categoria||'SIMPATIZANTE',color:f.properties?.color||'#7a1c24',ambito:f.properties?.ambito||'SECCION',ambito_clave:f.properties?.ambito_clave||'',mun:f.properties?.mun||'',df:f.properties?.df||'',dl:f.properties?.dl||'',seccion:f.properties?.seccion||'',lat:f.geometry?.coordinates?.[1]??null,lng:f.geometry?.coordinates?.[0]??null,notas:f.properties?.notas||'',prueba:!!f.properties?.prueba,created_at:f.properties?.created_at||new Date().toISOString()}));const replace=confirm('¿Reemplazar registros locales con los de GitHub?\nAceptar = Reemplazar, Cancelar = Fusionar');const next=replace?nuevos:base.concat(nuevos);guardar(next);toast(`Cargados ${nuevos.length} registros desde GitHub`);dibujarCapa();if(capaRegistros.getLayers().length){map.fitBounds(capaRegistros.getBounds(),{padding:[30,30]})}}catch(err){console.error(err);toast('Error al cargar desde GitHub')}});
function logTest(m){const el=$('#testlog');if(!el)return;el.style.display='block';el.textContent+=`\n${m}`;console.log(m)}
async function runSelfTests(){try{logTest('— Iniciando auto-tests…');const ok1=matchName('León','leon')&&matchName('SAN JOSE','José')&&matchName('Pénjamo','pen');if(!ok1)throw new Error('matchName falló');const catalog={'1':'Abasolo','2':'Acámbaro','21':'León'};MUN_CATALOG=catalog;if(!munMatchesFeature({properties:{MUNICIPIO:21}},'León'))throw new Error('munMatchesFeature nombre→código falló');if(!munMatchesFeature({properties:{MUNICIPIO:21}},'21'))throw new Error('munMatchesFeature código falló');if(!munMatchesRecord({mun:21},'leon'))throw new Error('munMatchesRecord nombre→código falló');logTest('OK catálogo municipal');logTest('— Auto-tests completados');toast('Auto-tests OK')}catch(err){logTest('ERROR tests: '+err.message);toast('Fallo en auto-tests')}}$('#btnRunTests')?.addEventListener('click',runSelfTests);if(location.hash==='#test'){runSelfTests()}
const panel=document.querySelector('.panel');const overlay=document.createElement('div');overlay.className='panel-overlay';document.querySelector('.map-wrap').appendChild(overlay);const toggleBtn=document.getElementById('btnTogglePanel');function togglePanel(open){const willOpen=open!==undefined?open:!panel.classList.contains('open');panel.classList.toggle('open',willOpen);overlay.classList.toggle('show',willOpen)}toggleBtn?.addEventListener('click',()=>togglePanel());overlay.addEventListener('click',()=>togglePanel(false));if(window.matchMedia('(max-width:1024px)').matches){setTimeout(()=>togglePanel(true),400)}
window.addEventListener('storage',e=>{if(e.key===STORAGE_KEY){renderTabla();dibujarCapa()}});
</script>
</body>
</html>