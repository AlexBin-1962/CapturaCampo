<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CT-27 · App de Campo (MVP)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Leaflet Locate (GPS) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css">
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
  <!-- Iconos -->
  <link href="https://unpkg.com/lucide-static@0.469.0/font/lucide.css" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f7f8;--panel:#ffffff;--ink:#1f2937;--muted:#6b7280;--brand:#7a1c24;--brand-soft:#f3e7e9;
      --ok:#16a34a;--warn:#ca8a04;--bad:#dc2626;--shadow:0 10px 25px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--ink)}
    .app{display:grid;grid-template-columns:360px 1fr;height:100%}
    /* Panel izquierdo */
    .panel{background:var(--panel);border-right:1px solid #e5e7eb;display:flex;flex-direction:column}
    .panel header{padding:16px 16px 8px;border-bottom:1px solid #f0f0f0}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--brand-soft);color:var(--brand);font-weight:600;font-size:12px;letter-spacing:.3px}
    .panel .section{padding:14px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:14px}
    textarea{min-height:70px;resize:vertical}
    .hint{font-size:12px;color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .legend{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    /* Mapa */
    #map{width:100%;height:100%}
    .map-wrap{position:relative}
    /* Barra flotante derecha */
    .floatbar{position:absolute;right:16px;top:16px;display:flex;flex-direction:column;gap:10px;z-index:500}
    .fab{border:none;border-radius:16px;background:#fff;box-shadow:var(--shadow);width:46px;height:46px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .fab:hover{transform:translateY(-1px)}
    .tooltip{position:absolute;right:56px;background:#111827;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;opacity:0;pointer-events:none;transform:translateY(4px);transition:all .15s}
    .fab-wrap{position:relative}
    .fab-wrap:hover .tooltip{opacity:1;transform:translateY(0)}
    /* Notificaciones */
    .toast{position:absolute;left:50%;top:16px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:700;display:none}
    /* Tabla ligera */
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    th{color:#6b7280;font-weight:700}
  </style>
  <!-- Turf.js para operaciones geoespaciales (point-in-polygon) -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    /* --- Ajustes móviles/tablet --- */
    @media (max-width: 1024px){
      .app{grid-template-columns:1fr;}
      .panel{position:absolute;z-index:600;inset:0 auto 0 0;width:min(92vw,420px);transform:translateX(-100%);transition:transform .2s ease;box-shadow:var(--shadow)}
      .panel.open{transform:translateX(0)}
      .panel-overlay{position:absolute;inset:0;background:rgba(0,0,0,.25);backdrop-filter:saturate(80%) blur(1px);display:none}
      .panel-overlay.show{display:block}
      .float-toggle{position:absolute;left:16px;top:16px;z-index:650;border:none;border-radius:16px;background:#fff;box-shadow:var(--shadow);width:46px;height:46px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- PANEL IZQUIERDO -->
  <aside class="panel">
    <header>
      <div class="badge">CT-27 · App de Campo · MVP</div>
      <div class="hint" style="margin-top:6px">Modo promotor (captura en sitio). Exporta a GeoJSON/CSV y comparte al admin.</div>
      <div class="hint" style="margin-top:6px;color:#374151"><b>Nota:</b> Versión móvil/tablet listo (panel deslizable). App independiente del portal.</div>
    </header>

    <div class="section">
      <h3 style="margin:0 0 10px 0">Nueva captura</h3>
      <div style="display:grid;gap:10px">
        <div>
          <label>Nombre completo</label>
          <input id="f_nombre" placeholder="Nombre y apellidos" />
        </div>
        <div class="row">
          <div>
            <label>Teléfono</label>
            <input id="f_tel" placeholder="10 dígitos" />
          </div>
          <div>
            <label>Identificador</label>
            <input id="f_id" placeholder="Clave interna opcional" />
          </div>
        </div>
        <div>
          <label>Domicilio</label>
          <input id="f_dom" placeholder="Calle y número" />
        </div>
        <div class="row">
          <div>
            <label>Colonia</label>
            <input id="f_colonia" placeholder="Colonia / Barrio" />
          </div>
          <div>
            <label>Ciudad</label>
            <input id="f_ciudad" placeholder="Ciudad / Municipio" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Código Postal</label>
            <input id="f_cp" placeholder="CP" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="btnGeocode" style="width:100%"><i class="lucide-map"></i><span>Geocodificar domicilio</span></button>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Categoría</label>
            <select id="f_cat"></select>
          </div>
          <div>
            <label>Color</label>
            <input id="f_color" type="color" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Ámbito</label>
            <select id="f_ambito">
              <option value="SECCION">SECCIÓN</option>
              <option value="MUNICIPIO">MUNICIPIO</option>
              <option value="DF">DISTRITO FEDERAL</option>
              <option value="DL">DISTRITO LOCAL</option>
            </select>
          </div>
          <div>
            <label>Clave de ámbito</label>
            <input id="f_ambito_clave" placeholder="Se autollenará por punto" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>MUNICIPIO (auto)</label>
            <input id="auto_mun" disabled placeholder="—" />
          </div>
          <div>
            <label>DIST. FEDERAL (auto)</label>
            <input id="auto_df" disabled placeholder="—" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>DIST. LOCAL (auto)</label>
            <input id="auto_dl" disabled placeholder="—" />
          </div>
          <div>
            <label>SECCIÓN (auto)</label>
            <input id="auto_sec" disabled placeholder="—" />
          </div>
        </div>
        <div>
          <label>Notas</label>
          <textarea id="f_notas" placeholder="Observaciones, acuerdos, seguimiento..."></textarea>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnPointer"><i class="lucide-map-pin"></i><span>Poner punto en mapa</span></button>
        <button class="btn" id="btnGPS"><i class="lucide-crosshair"></i><span>Usar GPS</span></button>
        <button class="btn btn-primary" id="btnGuardar"><i class="lucide-save"></i><span>Guardar</span></button>
      </div>
      <div class="hint" style="margin-top:6px">Tip: puedes geocodificar por domicilio y se llenarán automáticamente MUNICIPIO, DF, DL y SECCIÓN.</div>
    </div>
    <div class="toolbar">
      <div class="hint" style="margin-top:6px">Consejo: captura primero datos y luego ubica el punto (click en mapa o GPS).</div>
    </div>

    <div class="section" style="border-top:1px solid #f0f0f0">
      <h3 style="margin:0 8px 10px 0;display:flex;align-items:center;gap:8px">Leyenda</h3>
      <div class="legend" id="legend"></div>
    </div>

    <div class="section" style="border-top:1px solid #f0f0f0">
      <h3 style="margin:0 0 10px 0;display:flex;align-items:center;gap:8px"><i class="lucide-git-commit"></i> Sincronización & Datos</h3>
      <div style="display:grid;gap:10px">
        <div>
          <label>URL secciones.geojson</label>
          <input id="cfg_url_secciones" placeholder="/ruta/secciones.geojson" />
        </div>
        <div class="row">
          <div>
            <label>GitHub Owner</label>
            <input id="cfg_gh_owner" placeholder="org o usuario" />
          </div>
          <div>
            <label>Repo</label>
            <input id="cfg_gh_repo" placeholder="nombre del repositorio" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Branch</label>
            <input id="cfg_gh_branch" placeholder="main" />
          </div>
          <div>
            <label>Ruta y archivo</label>
            <input id="cfg_gh_path" placeholder="data/ct27_registros.geojson" />
          </div>
        </div>
        <div>
          <label>Token GitHub (no se guarda en servidor)</label>
          <input id="cfg_gh_token" type="password" placeholder="token con permiso de contents" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnSaveConfig"><i class="lucide-save"></i><span>Guardar configuración</span></button>
        <button class="btn" id="btnTestSecciones"><i class="lucide-check-circle-2"></i><span>Probar secciones</span></button>
        <button class="btn btn-primary" id="btnSyncGitHub"><i class="lucide-cloud-upload"></i><span>Sincronizar a GitHub</span></button>
      </div>
      <div class="hint" style="margin-top:6px">Sugerencia: usa un token de GitHub <em>fine-grained</em> con permiso a <b>Contents: Read & Write</b> solo en el repo destino.</div>
    </div>
  </aside>

  <!-- MAPA -->
  <main class="map-wrap">
    <!-- Botón para abrir/cerrar panel en móvil -->
    <button class="float-toggle" id="btnTogglePanel" title="Panel"><i class="lucide-menu"></i></button>
    <div id="map"></div>
    <div class="toast" id="toast"></div>
    <div class="floatbar">
      <div class="fab-wrap">
        <button class="fab" id="btnSearch"><i class="lucide-search"></i></button>
        <div class="tooltip">Buscar dirección (Nominatim)</div>
      </div>
      <div class="fab-wrap">
        <button class="fab" id="btnLocate"><i class="lucide-crosshair"></i></button>
        <div class="tooltip">Centrar en mi ubicación</div>
      </div>
      <div class="fab-wrap">
        <button class="fab" id="btnFit"><i class="lucide-maximize-2"></i></button>
        <div class="tooltip">Ajustar a marcadores</div>
      </div>
    </div>
  </main>
</div>

<script>
// ======= Configuración básica =======
const CATEGORIAS = [
  { id:"SIMPATIZANTE", color:"#60a5fa" },
  { id:"LIDER", color:"#22c55e" },
  { id:"ADVERSARIO", color:"#ef4444" },
  { id:"REP_CASILLA", label:"REP. CASILLA", color:"#a855f7" },
  { id:"REP_GENERAL", label:"REP. GENERAL", color:"#f59e0b" },
  { id:"OBSERVADOR", color:"#94a3b8" }
];

// URL del GeoJSON de secciones (ajusta la ruta a tu dataset)
const DEFAULT_URL_SECCIONES = '/data/geo/secciones.geojson';
let SECCIONES_FC = null; // FeatureCollection en memoria
const CONFIG_KEY = 'ct27_campo_config_v1';
let CONFIG = { url_secciones: DEFAULT_URL_SECCIONES, gh_owner:'', gh_repo:'', gh_branch:'main', gh_path:'data/ct27_registros.geojson', gh_token:'' };

const STORAGE_KEY = 'ct27_campo_registros_v1';
let modoColocar = false; // si true, el siguiente click en el mapa coloca punto
let punteroTemporal = null; // marker temporal para vista previa

// ======= Utilidades =======
const $ = sel => document.querySelector(sel);
function toast(msg, ms=1800){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }
function descargar(nombre, contenido){
  const blob = new Blob([contenido], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=nombre; a.click(); URL.revokeObjectURL(url);
}
function getCurrentGeoJSON(){
  const regs = cargar();
  return {
    type: 'FeatureCollection',
    features: regs.filter(r => r.lat && r.lng).map(r => ({
      type: 'Feature',
      properties: {
        id: r.id,
        nombre: r.nombre,
        tel: r.tel,
        domicilio: r.domicilio,
        categoria: r.categoria,
        color: r.color,
        ambito: r.ambito,
        ambito_clave: r.ambito_clave,
        mun: r.mun,
        df: r.df,
        dl: r.dl,
        seccion: r.seccion,
        notas: r.notas,
        created_at: r.created_at
      },
      geometry: { type: 'Point', coordinates: [r.lng, r.lat] }
    }))
  };
}
function toCSV(rows){
  const esc = v => '"'+String(v??'').replaceAll('"','""')+'"';
  const header = Object.keys(rows[0]||{}); 
  const lines = [header.map(esc).join(',')];
  for(const r of rows){ lines.push(header.map(k=>esc(r[k])).join(',')); }
  return lines.join('\n');
}

// ======= Estado (LocalStorage) =======
function cargar(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; }
}
function guardar(regs){ localStorage.setItem(STORAGE_KEY, JSON.stringify(regs)); renderTabla(); renderLegend(); dibujarCapa(); }

// ======= UI inicial =======
(function initForm(){
  const sel = $('#f_cat');
  CATEGORIAS.forEach(c=>{
    const opt=document.createElement('option');
    opt.value=c.id; opt.textContent=c.label||c.id; sel.appendChild(opt);
  });
  sel.addEventListener('change', e=>{
    const cat = CATEGORIAS.find(x=>x.id===e.target.value); $('#f_color').value = cat?.color || '#7a1c24';
  });
  // valor inicial
  sel.value='SIMPATIZANTE'; $('#f_color').value = CATEGORIAS[0].color;
})();

// ======= Mapa =======
const map = L.map('map', { zoomControl:true }).setView([21.122, -101.682], 12);
const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

// Cargar SECCIONES para autocompletar (MUNICIPIO/DF/DL/SECCION)
(async function cargarSecciones(){
  try{
    cargarConfig(); // asegura CONFIG antes
    const res = await fetch(CONFIG.url_secciones || DEFAULT_URL_SECCIONES);
    SECCIONES_FC = await res.json();
  }catch(e){ console.warn('No se pudo cargar secciones.geojson', e); }
})();

// controlar click para colocar punto
map.on('click', (e)=>{
  if(!modoColocar) return;
  colocarPuntero(e.latlng);
});

function colocarPuntero(latlng){
  if(punteroTemporal) map.removeLayer(punteroTemporal);
  punteroTemporal = L.circleMarker(latlng, { radius:8, weight:2, color:'#111827', fillColor: $('#f_color').value, fillOpacity:.9 });
  punteroTemporal.addTo(map);
  punteroTemporal.bindTooltip('Punto provisional', {permanent:false});
  modoColocar=false; $('#btnPointer').disabled=false; toast('Punto colocado. Ahora “Guardar”.');
  autocompletarAmbitoDesdeSecciones(latlng);
}

// Locate control (botón flotante)
$('#btnLocate').addEventListener('click', ()=>{
  map.locate({ setView:true, maxZoom:17 });
});
map.on('locationerror', ()=> toast('No se pudo obtener tu ubicación. Revisa permisos.'));

// Ajustar a marcadores
$('#btnFit').addEventListener('click', fitBoundsToData);
function fitBoundsToData(){
  if(capaRegistros.getLayers().length===0){ toast('No hay marcadores aún.'); return; }
  map.fitBounds(capaRegistros.getBounds(), {padding:[30,30]});
}

// Buscar dirección (Nominatim — requiere internet)
$('#btnSearch').addEventListener('click', async ()=>{
  const q = prompt('Buscar dirección (ciudad, calle, número)...');
  if(!q) return;
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, {headers:{'Accept-Language':'es'}});
    const data = await res.json();
    if(!data.length) return toast('Sin resultados. Refina la búsqueda.');
    const {lat, lon, display_name} = data[0];
    const p = L.latLng(parseFloat(lat), parseFloat(lon));
    map.setView(p, 17);
    toast(display_name);
  }catch(err){ toast('Error al buscar. ¿Sin internet?'); }
});

// ======= Capa de registros =======
const capaRegistros = L.layerGroup().addTo(map);
function dibujarCapa(){
  capaRegistros.clearLayers();
  const regs = cargar();
  regs.forEach((r,i)=>{
    if(!r.lat || !r.lng) return; // seguridad
    const mk = L.circleMarker([r.lat, r.lng], { radius:7, weight:2, color:'#111827', fillColor:r.color || '#7a1c24', fillOpacity:.9 });
    mk.bindTooltip(`${r.categoria || 'CAT'} · ${r.nombre || 'Sin nombre'}`, {permanent:false});
    mk.bindPopup(`<b>${r.nombre || ''}</b><br>${r.categoria} · ${r.ambito} ${r.ambito_clave || ''}<br>${r.domicilio || ''}<br><small>${r.notas || ''}</small>`);
    capaRegistros.addLayer(mk);
  });
}

// ======= Geocodificación por domicilio =======
$('#btnGeocode').addEventListener('click', async ()=>{
  const part = [$('#f_dom').value, $('#f_colonia').value, $('#f_ciudad').value, $('#f_cp').value].filter(Boolean).join(', ');
  if(!part) return toast('Escribe al menos calle/número y ciudad');
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(part)}`;
    const res = await fetch(url, {headers:{'Accept-Language':'es'}});
    const data = await res.json();
    if(!data.length) return toast('Sin resultados para ese domicilio');
    const best = data[0];
    const latlng = L.latLng(parseFloat(best.lat), parseFloat(best.lon));
    map.setView(latlng, 18);
    colocarPuntero(latlng);
  }catch(err){ toast('Error al geocodificar'); }
});

// ======= Interacciones panel =======
$('#btnPointer').addEventListener('click', ()=>{ modoColocar=true; $('#btnPointer').disabled=true; toast('Click en el mapa para colocar el punto'); });
$('#btnGPS').addEventListener('click', ()=>{
  map.locate({ setView:true, maxZoom:18, watch:false, enableHighAccuracy:true });
  map.once('locationfound', e=>{ colocarPuntero(e.latlng); });
});

$('#btnGuardar').addEventListener('click', ()=>{
  // Validaciones mínimas
  const nombre = $('#f_nombre').value.trim();
  const categoria = $('#f_cat').value;
  if(!nombre){ toast('Falta nombre'); return; }
  if(!punteroTemporal){ toast('Coloca el punto (mapa/GPS/geocodificación)'); return; }

  const regs = cargar();
  const nuevo = {
    id: $('#f_id').value.trim() || `R${Date.now()}`,
    nombre,
    tel: $('#f_tel').value.trim(),
    domicilio: [$('#f_dom').value.trim(), $('#f_colonia').value.trim(), $('#f_ciudad').value.trim(), $('#f_cp').value.trim()].filter(Boolean).join(', '),
    categoria,
    color: $('#f_color').value,
    ambito: $('#f_ambito').value,
    ambito_clave: $('#f_ambito_clave').value.trim(),
    mun: $('#auto_mun').value || '',
    df: $('#auto_df').value || '',
    dl: $('#auto_dl').value || '',
    seccion: $('#auto_sec').value || '',
    notas: $('#f_notas').value.trim(),
    lat: punteroTemporal.getLatLng().lat,
    lng: punteroTemporal.getLatLng().lng,
    created_at: new Date().toISOString()
  };
  regs.push(nuevo); guardar(regs);
  if(punteroTemporal){ map.removeLayer(punteroTemporal); punteroTemporal=null; }
  limpiarForm(); toast('Registro guardado');
});

function limpiarForm(){
  ['#f_nombre','#f_tel','#f_id','#f_dom','#f_colonia','#f_ciudad','#f_cp','#f_notas','#f_ambito_clave','#auto_mun','#auto_df','#auto_dl','#auto_sec'].forEach(s=> $(s).value='');
}

$('#btnLimpiar').addEventListener('click', ()=>{
  if(confirm('¿Eliminar TODOS los registros locales?')){ localStorage.removeItem(STORAGE_KEY); guardar([]); toast('Registros eliminados'); }
});

$('#btnExportGeo').addEventListener('click', ()=>{
  const fc = getCurrentGeoJSON();
  descargar(`ct27_campo_${new Date().toISOString().slice(0,10)}.geojson`, JSON.stringify(fc, null, 2));
});

$('#btnExportCSV').addEventListener('click', ()=>{
  const regs = cargar();
  if(!regs.length) return toast('Sin datos');
  const rows = regs.map(r=>({
    id:r.id,nombre:r.nombre,tel:r.tel,domicilio:r.domicilio,categoria:r.categoria,color:r.color,ambito:r.ambito,ambito_clave:r.ambito_clave,notas:r.notas,lat:r.lat,lng:r.lng,created_at:r.created_at
  }));
  const csv = toCSV(rows); 
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`ct27_campo_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
});

// Importar GeoJSON
$('#fileImport').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const text = await file.text(); const json = JSON.parse(text);
    if(json.type!=='FeatureCollection') throw new Error('No es FeatureCollection');
    const base = cargar();
    const nuevos = (json.features||[]).map((f,i)=>({
      id: f.properties?.id || `IMP${Date.now()}_${i}`,
      nombre: f.properties?.nombre || '',
      tel: f.properties?.tel || '',
      domicilio: f.properties?.domicilio || '',
      categoria: f.properties?.categoria || 'SIMPATIZANTE',
      color: f.properties?.color || '#7a1c24',
      ambito: f.properties?.ambito || 'SECCION',
      ambito_clave: f.properties?.ambito_clave || '',
      notas: f.properties?.notas || '',
      lat: f.geometry?.coordinates?.[1] || null,
      lng: f.geometry?.coordinates?.[0] || null,
      created_at: f.properties?.created_at || new Date().toISOString()
    }));
    guardar(base.concat(nuevos)); toast(`Importados ${nuevos.length} registros`);
    e.target.value='';
  }catch(err){ toast('Archivo inválido'); }
});

// Tabla
function renderTabla(){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML='';
  const regs = cargar();
  regs.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.nombre||''}</td><td>${r.categoria||''}</td><td>${r.seccion||r.ambito||''}</td><td>${(r.lat||'').toFixed? r.lat.toFixed(5):''}</td><td>${(r.lng||'').toFixed? r.lng.toFixed(5):''}</td>`;
    tbody.appendChild(tr);
  });
});
}

// Leyenda
function renderLegend(){
  const l = $('#legend'); l.innerHTML='';
  CATEGORIAS.forEach(c=>{
    const chip = document.createElement('div'); chip.className='chip';
    chip.innerHTML = `<span class="dot" style="background:${c.color}"></span>${c.label||c.id}`;
    l.appendChild(chip);
  });
}

// Inicio
renderTabla(); renderLegend(); dibujarCapa();

// Cargar config en inputs
function cargarConfig(){
  try{ CONFIG = Object.assign(CONFIG, JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}')); }catch{ /*noop*/ }
  $('#cfg_url_secciones')?.setAttribute('value', CONFIG.url_secciones||'');
  $('#cfg_gh_owner')?.setAttribute('value', CONFIG.gh_owner||'');
  $('#cfg_gh_repo')?.setAttribute('value', CONFIG.gh_repo||'');
  $('#cfg_gh_branch')?.setAttribute('value', CONFIG.gh_branch||'');
  $('#cfg_gh_path')?.setAttribute('value', CONFIG.gh_path||'');
}
function guardarConfig(){
  // Normaliza ruta a formato URL (forward slashes)
  const norm = (s)=> (s||'').replace(/\\/g,'/');
  const next = {
    url_secciones: norm($('#cfg_url_secciones')?.value?.trim()) || CONFIG.url_secciones,
    gh_owner: $('#cfg_gh_owner')?.value?.trim()||'',
    gh_repo: $('#cfg_gh_repo')?.value?.trim()||'',
    gh_branch: $('#cfg_gh_branch')?.value?.trim()||'main',
    gh_path: norm($('#cfg_gh_path')?.value?.trim()||'data/ct27_registros.geojson')
  };
  CONFIG = Object.assign(CONFIG, next);
  localStorage.setItem(CONFIG_KEY, JSON.stringify(CONFIG));
}

cargarConfig();

// Toggle panel en móvil
const panel = document.querySelector('.panel');
const overlay = document.createElement('div'); overlay.className='panel-overlay';
document.querySelector('.map-wrap').appendChild(overlay);
const toggleBtn = document.getElementById('btnTogglePanel');
function togglePanel(open){
  const willOpen = open!==undefined ? open : !panel.classList.contains('open');
  panel.classList.toggle('open', willOpen); overlay.classList.toggle('show', willOpen);
}
toggleBtn?.addEventListener('click', ()=> togglePanel());
overlay.addEventListener('click', ()=> togglePanel(false));
// Abre por defecto 1 vez en móvil para indicar que existe
if(window.matchMedia('(max-width:1024px)').matches){ setTimeout(()=>togglePanel(true), 400); }('click', ()=> togglePanel(false));
// Abre por defecto 1 vez en móvil para indicar que existe
if(window.matchMedia('(max-width:1024px)').matches){ setTimeout(()=>togglePanel(true), 400); }

// Observa cambios de almacenamiento desde otras pestañas
window.addEventListener('storage', (e)=>{ if(e.key===STORAGE_KEY) { renderTabla(); dibujarCapa(); }});
// ======= Autocompletar Ámbito desde Secciones =======
function autocompletarAmbitoDesdeSecciones(latlng){
  if(!SECCIONES_FC?.features?.length) return; // si no cargó el archivo, no falla
  const pt = turf.point([latlng.lng, latlng.lat]);
  // Búsqueda lineal (MVP). Para producción: indexación por bbox/quadtree.
  for(const f of SECCIONES_FC.features){
    try{
      if(turf.booleanPointInPolygon(pt, f)){
        const p = f.properties || {};
        $('#auto_mun').value = p.MUNICIPIO ?? p.MUN ?? '';
        $('#auto_df').value  = p.DISTRITO_F ?? p.DF ?? '';
        $('#auto_dl').value  = p.DISTRITO_L ?? p.DL ?? '';
        $('#auto_sec').value = p.SECCION ?? p.SEC ?? '';
        // Sugerimos ámbito/clave por defecto
        $('#f_ambito').value = 'SECCION';
        $('#f_ambito_clave').value = $('#auto_sec').value || '';
        break;
      }
    }catch{ /* ignora geometrias inválidas */ }
  }
}
// ======= Autocompletar Ámbito desde Secciones =======
function autocompletarAmbitoDesdeSecciones(latlng){
  if(!SECCIONES_FC?.features?.length) return; // si no cargó el archivo, no falla
  const pt = turf.point([latlng.lng, latlng.lat]);
  for(const f of SECCIONES_FC.features){
    try{
      if(turf.booleanPointInPolygon(pt, f)){
        const p = f.properties || {};
        $('#auto_mun').value = p.MUNICIPIO ?? p.MUN ?? '';
        $('#auto_df').value  = p.DISTRITO_F ?? p.DF ?? '';
        $('#auto_dl').value  = p.DISTRITO_L ?? p.DL ?? '';
        $('#auto_sec').value = p.SECCION ?? p.SEC ?? '';
        $('#f_ambito').value = 'SECCION';
        $('#f_ambito_clave').value = $('#auto_sec').value || '';
        break;
      }
    }catch{ /* ignora geometrias inválidas */ }
  }
}

// ======= Acciones de Configuración =======
$('#btnSaveConfig')?.addEventListener('click', ()=>{ guardarConfig(); toast('Configuración guardada'); });
$('#btnTestSecciones')?.addEventListener('click', async ()=>{
  try{
    guardarConfig();
    const res = await fetch(CONFIG.url_secciones||DEFAULT_URL_SECCIONES);
    if(!res.ok) throw new Error('HTTP '+res.status);
    SECCIONES_FC = await res.json();
    toast('Secciones cargadas OK');
  }catch(e){ toast('Error al cargar secciones'); }
});

// ======= Sincronizar a GitHub (Contents API) =======
async function ghGetFile(owner, repo, path, branch){
  const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`);
  if(r.status===404) return null; // no existe
  if(!r.ok) throw new Error('GET contents failed');
  return await r.json();
}
function toBase64Utf8(str){
  const utf8 = new TextEncoder().encode(str);
  let binary=''; utf8.forEach(b=> binary += String.fromCharCode(b));
  return btoa(binary);
}
async function ghPutFile({owner, repo, path, branch, token, content, message}){
  const existing = await ghGetFile(owner, repo, path, branch).catch(()=>null);
  const body = { message, content: toBase64Utf8(content), branch };
  if(existing?.sha) body.sha = existing.sha;
  const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {
    method:'PUT', headers:{ 'Authorization': `Bearer ${token}`, 'Accept':'application/vnd.github+json' }, body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error('PUT contents failed');
  return await r.json();
}

$('#btnSyncGitHub')?.addEventListener('click', async ()=>{
  try{
    guardarConfig();
    const owner = CONFIG.gh_owner, repo = CONFIG.gh_repo, branch = CONFIG.gh_branch, path = CONFIG.gh_path;
    const token = $('#cfg_gh_token')?.value?.trim();
    if(!owner||!repo||!branch||!path||!token) return toast('Faltan datos de GitHub');
    const fc = getCurrentGeoJSON();
    const payload = JSON.stringify(fc, null, 2);
    await ghPutFile({owner, repo, path, branch, token, content: payload, message: `CT-27: sync ${new Date().toISOString()}`});
    toast('Sincronizado en GitHub ✅');
  }catch(e){ console.error(e); toast('Error al sincronizar'); }
});
</script>
</body>
</html>
